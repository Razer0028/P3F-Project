<?php
session_start();
header('Content-Type: text/html; charset=UTF-8');
require_once __DIR__ . '/portal_config.php';

/* ===== è¨­å®š ===== */
const WHITELIST_PATH      = '{{ containers_root }}/minecraft/data/whitelist.json';   // â† ä¿®æ­£æ¸ˆã¿
const PLAYER_STATUS_JSON  = '/opt/serveradmin/status/current_players.json';
const SHOW_WL_DETAILS     = false;
$portalConfig = portal_load_config();
$autoStopEnabled = (bool)($portalConfig['auto_stop_enabled'] ?? false);
$autoStopMinutes = intval($portalConfig['auto_stop_minutes'] ?? 10);
if ($autoStopMinutes <= 0) {
    $autoStopMinutes = 10;
}
$SERVERS = [];
foreach (portal_enabled_services($portalConfig, 'game') as $service) {
    if (!(bool)($service['public'] ?? true)) {
        continue;
    }
    $SERVERS[] = [
        'id'        => $service['id'],
        'label'     => $service['label'] ?? $service['id'],
        'container' => $service['container'] ?? $service['id'],
        'img'       => $service['img'] ?? '/images/soldir.jpg',
        'hostport'  => $service['hostport'] ?? '',
        'howto'     => $service['howto'] ?? '',
        'password'  => $service['password'] ?? null,
        'extra'     => $service['extra'] ?? null,
    ];
}
$minecraftEnabled = false;
foreach ($SERVERS as $srv) {
    if (($srv['id'] ?? '') === 'minecraft') {
        $minecraftEnabled = true;
        break;
    }
}

/* ===== Utility ===== */
function h($s){ return htmlspecialchars($s ?? '', ENT_QUOTES, 'UTF-8'); }

function redirect_self_303(){
    header('Location: '.basename(__FILE__), true, 303);
    exit;
}

function send_discord($msg){
    $webhook = getenv('DISCORD_WEBHOOK_URL');
    if(!$webhook || !filter_var($webhook,FILTER_VALIDATE_URL)){
        return false;
    }
    $ch = curl_init($webhook);
    curl_setopt_array($ch,[
        CURLOPT_POST=>true,
        CURLOPT_POSTFIELDS=>json_encode(['content'=>$msg],JSON_UNESCAPED_UNICODE),
        CURLOPT_HTTPHEADER=>['Content-Type: application/json'],
        CURLOPT_RETURNTRANSFER=>true,
        CURLOPT_TIMEOUT=>6,
    ]);
    curl_exec($ch);
    curl_close($ch);
    return true;
}

/* Mojang UUID å–å¾— */
function mc_fetch_uuid_hyphenated($name){
    $name = trim($name);
    if(!preg_match('/^[A-Za-z0-9_]{3,16}$/',$name)){
        return [null,'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãŒä¸æ­£ã§ã™ï¼ˆ3ã€œ16æ–‡å­—ã®è‹±æ•°ã¨_ï¼‰'];
    }

    // Ashcon APIï¼ˆCloudflare CDNï¼‰
    $url = "https://api.ashcon.app/mojang/v2/user/".rawurlencode($name);

    $ch = curl_init($url);
    curl_setopt_array($ch,[
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT        => 6,
        CURLOPT_USERAGENT      => 'public_portal/1.0'
    ]);
    $res = curl_exec($ch);
    $code = curl_getinfo($ch, CURLINFO_RESPONSE_CODE);
    curl_close($ch);

    if($code !== 200 || !$res){
        return [null, 'UUIDã‚’å–å¾—ã§ãã¾ã›ã‚“ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ï¼‰'];
    }

    $data = json_decode($res, true);
    if(!isset($data['uuid'])){
        return [null, 'UUIDå–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ï¼‰'];
    }

    // æ—¢ã«ãƒã‚¤ãƒ•ãƒ³ä»˜ãã§è¿”ã£ã¦ãã‚‹ãŒå¿µã®ãŸã‚æ­£è¦åŒ–
    $u = str_replace('-', '', $data['uuid']);
    $hy = substr($u,0,8).'-'.substr($u,8,4).'-'.substr($u,12,4).'-'.substr($u,16,4).'-'.substr($u,20);

    return [$hy, null];
}

/* JSON ãƒ­ãƒƒã‚¯è¿½è¨˜ */
function json_file_lock_append($path,$row){
    $fp=fopen($path,'c+');
    if(!$fp) return false;
    if(!flock($fp,LOCK_EX)){ fclose($fp); return false; }
    $cur=stream_get_contents($fp);
    $arr=$cur?json_decode($cur,true):[];
    if(!is_array($arr)) $arr=[];
    $arr[]=$row;
    ftruncate($fp,0); rewind($fp);
    fwrite($fp,json_encode($arr,JSON_PRETTY_PRINT|JSON_UNESCAPED_UNICODE));
    fflush($fp); flock($fp,LOCK_UN); fclose($fp);
    return true;
}

/* ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆè¿½åŠ  */
function whitelist_add($name,$uuid){
    $fp=fopen(WHITELIST_PATH,'c+');
    if(!$fp) return 'whitelist.jsonã‚’é–‹ã‘ã¾ã›ã‚“ï¼ˆæ¨©é™ç¢ºèªï¼‰';
    if(!flock($fp,LOCK_EX)){ fclose($fp); return 'whitelist.jsonã®ãƒ­ãƒƒã‚¯å¤±æ•—'; }

    $data=stream_get_contents($fp);
    $arr=$data?json_decode($data,true):[];
    if(!is_array($arr)) $arr=[];

    foreach($arr as $e){
        if(isset($e['name']) && strcasecmp($e['name'],$name)===0){
            flock($fp,LOCK_UN); fclose($fp);
            return 'ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™';
        }
        if(isset($e['uuid']) && strcasecmp($e['uuid'],$uuid)===0){
            flock($fp,LOCK_UN); fclose($fp);
            return 'ã“ã®UUIDã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™';
        }
    }
    $arr[]=['uuid'=>$uuid,'name'=>$name];

    ftruncate($fp,0); rewind($fp);
    fwrite($fp,json_encode($arr,JSON_PRETTY_PRINT|JSON_UNESCAPED_UNICODE));
    fflush($fp); flock($fp,LOCK_UN); fclose($fp);
    return null;
}

/* ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ */
function whitelist_list(){
    if(!is_file(WHITELIST_PATH)) return [];
    $arr=json_decode(@file_get_contents(WHITELIST_PATH),true);
    return is_array($arr)?$arr:[];
}

/* docker ã‚³ãƒãƒ³ãƒ‰ */
function docker_cmd($args){
    $docker = trim((string)shell_exec('command -v docker'));
    if($docker==='') $docker='/usr/bin/docker';

    exec("$docker $args 2>&1",$out,$rc);
    $outStr=implode("\n",$out);

    if($rc!==0 || stripos($outStr,'permission denied')!==false){
        exec("sudo -n $docker $args 2>&1",$out,$rc);
        $outStr=implode("\n",$out);
    }
    return ['out'=>$outStr,'rc'=>$rc];
}

/* dockerã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ */
function docker_status($container){
    $c = escapeshellarg($container);
{% raw %}
    $run = docker_cmd("inspect -f '{{.State.Running}}' $c");
    $health = docker_cmd("inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{end}}' $c");
{% endraw %}
    return [
        'running' => ($run['rc']===0 && trim($run['out'])==='true'),
        'health'  => ($health['rc']===0 && ($h=trim($health['out']))!=='' && strtolower($h)!=='null') ? $h : null,
    ];
}

/* current players */
function read_current_players(){
    if(!is_file(PLAYER_STATUS_JSON)) return null;
    $data=json_decode(@file_get_contents(PLAYER_STATUS_JSON),true);
    return is_array($data)?$data:null;
}

/* ===== action=status (AJAX) ===== */
if(($_GET['action'] ?? '') === 'status'){
    $list=[];
    foreach($SERVERS as $s){
        $st=docker_status($s['container']);
        $list[$s['id']] = [
            'id'=>$s['id'],
            'label'=>$s['label'],
            'running'=>$st['running'],
            'health'=>$st['health'],
            'hostport'=>$s['hostport'],
        ];
    }
    $players_now=read_current_players();
    echo json_encode([
        'servers'=>$list,
        'players_now'=>$players_now,
        'ts'=>date('Y-m-d H:i:s'),
    ],JSON_UNESCAPED_UNICODE);
    exit;
}

/* ===== POSTï¼ˆwhitelist / feedbackï¼‰===== */
if($_SERVER['REQUEST_METHOD']==='POST'){
    $type = $_POST['type'] ?? '';
    if($type==='whitelist'){
        if (!$minecraftEnabled) {
            $_SESSION['flash'] = ['âŒ Minecraft ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error'];
            redirect_self_303();
        }
        $name = trim($_POST['mc_name'] ?? '');
        if($name===''){
            $_SESSION['flash']=['âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'];
        }else{
            [$uuid,$err] = mc_fetch_uuid_hyphenated($name);
            if($err){
                $_SESSION['flash']=["âŒ $err",'error'];
            }else{
                $err2=whitelist_add($name,$uuid);
                if($err2){
                    $_SESSION['flash']=["âŒ ç™»éŒ²ã«å¤±æ•—: $err2",'error'];
                }else{
                    $_SESSION['flash']=['âœ… ç™»éŒ²ã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã§ãã¾ã™ã€‚','success'];
                    send_discord("âœ… Minecraft ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²: {$name} ({$uuid})");
                }
            }
        }
        redirect_self_303();
    }

    if($type==='feedback'){
        $text=trim($_POST['feedback'] ?? '');
        if($text===''){
            $_SESSION['flash']=['âŒ ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ä¿¡ã§ãã¾ã›ã‚“ã€‚','error'];
        }else{
            json_file_lock_append(__DIR__.'/feedback.json',[
                'message'=>$text,
                'time'=>date('Y-m-d H:i:s')
            ]);
            send_discord("ğŸ“® ã”æ„è¦‹/ä¸å…·åˆå ±å‘Š:\n".$text);
            $_SESSION['flash']=['âœ… ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼é‹å–¶ã«é€ä¿¡ã—ã¾ã—ãŸã€‚','success'];
        }
        redirect_self_303();
    }
}

/* ===== åˆæœŸè¡¨ç¤º ===== */
[$flashMsg,$flashType] = $_SESSION['flash'] ?? [null,'success'];
unset($_SESSION['flash']);

$whitelist = whitelist_list();
if (!$minecraftEnabled) {
    $whitelist = [];
}

$initialServers=[];
foreach($SERVERS as $s){
    $initialServers[$s['id']] = docker_status($s['container']);
}
$initialPlayers = read_current_players();

?>
<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ ãƒãƒ¼ã‚¿ãƒ«</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap');

:root{
  --bg:#f5f7fb;
  --bg-grad:radial-gradient(circle at 12% 12%,rgba(14,165,164,.18) 0%,transparent 55%),
            radial-gradient(circle at 90% 0%,rgba(59,130,246,.16) 0%,transparent 55%),
            linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%);
  --surface:#ffffff;
  --surface-2:#f1f5f9;
  --border:#e2e8f0;
  --text:#0f172a;
  --muted:#475569;
  --accent:#0f766e;
  --accent-2:#1d4ed8;
  --accent-soft:#ccfbf1;
  --ok:#15803d;
  --ok-soft:#dcfce7;
  --warn:#b54708;
  --warn-soft:#ffedd5;
  --danger:#b42318;
  --danger-soft:#fee2e2;
  --r-lg:18px;
  --r-md:12px;
  --r-sm:8px;
  --shadow:0 16px 40px rgba(15,23,42,.1);
  --shadow-soft:0 8px 20px rgba(15,23,42,.08);
  --fast:.16s ease;
  --font-head:"Space Grotesk","Zen Kaku Gothic New",sans-serif;
  --font-body:"Zen Kaku Gothic New","Space Grotesk",sans-serif;
}
*{box-sizing:border-box;-webkit-font-smoothing:antialiased;}
body{
  margin:0;min-height:100vh;display:flex;flex-direction:column;
  font-family:var(--font-body);
  color:var(--text);
  background:var(--bg);
  background-image:var(--bg-grad);
  background-attachment:fixed;
}
.site-header{
  position:sticky;top:0;z-index:100;
  background:rgba(255,255,255,.9);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(12px);
  padding:12px 16px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  font-size:12px;line-height:1.4;
}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text);font-family:var(--font-head);} 
.brand-icon{
  width:34px;height:34px;border-radius:10px;
  background:linear-gradient(135deg,#0f766e 0%,#14b8a6 100%);
  color:#fff;display:flex;align-items:center;justify-content:center;
  font-size:15px;font-weight:700;box-shadow:var(--shadow-soft);
}
.header-right{color:var(--muted);text-align:right;} 
.status-dot{width:7px;height:7px;border-radius:999px;background:var(--accent);display:inline-block;margin-right:6px;box-shadow:0 0 10px rgba(15,118,110,.5);} 

.main-wrap{
  width:100%;max-width:1200px;margin:18px auto 48px;padding:0 16px 32px;
  display:grid;gap:18px;grid-template-columns:1fr;
}
@media(min-width:960px){
  .main-wrap{grid-template-columns:minmax(0,1.2fr) minmax(0,.8fr);} 
}

.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r-lg);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card-header{
  padding:14px 16px;
  display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;
  border-bottom:1px solid var(--border);
  background:linear-gradient(120deg,rgba(15,118,110,.08),rgba(29,78,216,.06));
  font-size:12px;color:var(--muted);
}
.card-title-main{color:var(--text);font-size:15px;font-weight:700;font-family:var(--font-head);} 
.card-eyebrow{font-weight:500;letter-spacing:.02em;} 
.card-time{font-weight:500;color:var(--muted);} 
.card-body{padding:16px;font-size:14px;line-height:1.5;color:var(--text);} 

.server-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));} 
.server-tile{
  display:flex;gap:12px;padding:14px;
  background:var(--surface-2);
  border:1px solid var(--border);
  border-radius:var(--r-md);
  box-shadow:var(--shadow-soft);
}
.server-icon img{
  width:54px;height:54px;border-radius:var(--r-md);object-fit:cover;
  border:1px solid var(--border);
}
.server-main{flex:1;min-width:0;display:flex;flex-direction:column;line-height:1.4;} 
.server-name{font-weight:700;font-size:14px;color:var(--text);display:flex;align-items:center;gap:6px;flex-wrap:wrap;} 
.server-addr{
  margin-top:4px;font-family:"Space Grotesk",ui-monospace,Menlo,Consolas,monospace;
  font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:8px;align-items:center;word-break:break-all;
}
.copy-btn{
  font-size:11px;line-height:1.2;padding:4px 8px;cursor:pointer;
  background:#fff;border:1px solid var(--border);border-radius:var(--r-sm);
  color:var(--accent);transition:var(--fast);
}
.copy-btn:hover{border-color:var(--accent);box-shadow:0 0 8px rgba(15,118,110,.2);} 
.server-players{font-size:12px;color:var(--muted);margin-top:8px;min-height:1.3em;} 
.badge{
  flex-shrink:0;align-self:flex-start;min-width:70px;text-align:center;
  font-size:11px;font-weight:700;line-height:1.3;padding:6px 10px;
  border-radius:999px;border:1px solid var(--border);
  background:var(--ok-soft);color:var(--ok);
}
.badge.ng{background:var(--danger-soft);color:var(--danger);} 
.badge.warn{background:var(--warn-soft);color:var(--warn);} 

.rules-block,.guide-block{color:var(--muted);font-size:13px;line-height:1.6;} 
.guide-block{
  background:var(--surface-2);
  border:1px solid var(--border);
  border-radius:var(--r-md);
  padding:12px 14px;
  margin-bottom:12px;
}
.guide-block code{
  font-family:"Space Grotesk",ui-monospace,Menlo,Consolas,monospace;font-size:12px;
  background:#fff;border:1px solid var(--border);
  border-radius:var(--r-sm);padding:2px 4px;color:var(--accent);
}
.rules-block strong{color:var(--text);font-weight:600;} 

.form-desc{color:var(--muted);font-size:13px;line-height:1.6;margin-bottom:12px;} 
.form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;font-size:13px;color:var(--text);} 
label{font-size:12px;font-weight:600;color:var(--text);} 
input[type=text],textarea{
  width:100%;padding:10px 12px;font-size:13px;line-height:1.4;color:var(--text);
  background:#fff;border:1px solid var(--border);
  border-radius:var(--r-md);outline:none;transition:var(--fast);
}
input[type=text]:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(15,118,110,.12);} 
textarea{min-height:110px;resize:vertical;font-family:"Space Grotesk",ui-monospace,Menlo,Consolas,monospace;} 

.btn-primary{
  appearance:none;border:1px solid transparent;
  cursor:pointer;border-radius:var(--r-md);padding:10px 14px;
  font-size:13px;line-height:1.4;font-weight:700;color:#fff;
  background:linear-gradient(135deg,#0f766e 0%,#14b8a6 100%);
  box-shadow:var(--shadow-soft);transition:var(--fast);
}
.btn-primary[disabled]{opacity:.6;cursor:default;} 
.btn-primary:hover:not([disabled]){filter:brightness(1.05);} 

.wl-stats-row{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px;font-size:13px;color:var(--text);} 

.toast{
  position:fixed;right:16px;bottom:16px;z-index:9999;
  max-width:280px;padding:12px 14px;border-radius:var(--r-md);
  background:var(--ok-soft);border:1px solid var(--border);
  box-shadow:var(--shadow);font-size:13px;line-height:1.4;color:var(--ok);
  opacity:0;transform:translateY(8px) scale(.98);transition:all .3s;
}
.toast.show{opacity:1;transform:translateY(0) scale(1);} 
.toast.err{background:var(--danger-soft);color:var(--danger);} 

.ts{font-size:11px;font-weight:500;line-height:1.4;color:var(--muted);} 
.page-bottom-space{height:40px;}
</style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <div class="brand-icon">ğŸ®</div>
    <div>
      <div style="font-size:13px;line-height:1.3;">ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ ãƒãƒ¼ã‚¿ãƒ«</div>
      <div style="font-size:11px;font-weight:400;color:var(--muted);line-height:1.3;">Multiplayer Sandbox / Internal Use</div>
    </div>
  </div>
  <div class="header-right">
    <div><span class="status-dot"></span>online dashboard</div>
    <div style="font-size:11px;">è‡ªå‹•åœæ­¢: <?= $autoStopEnabled ? 'ON' : 'OFF' ?> Â· whitelist self-service</div>
  </div>
</header>

<main class="main-wrap">
  <!-- LEFT -->
  <section>
    <!-- status -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title-main">ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div class="card-eyebrow">ç¾åœ¨ã®ç¨¼åƒçŠ¶æ³ / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äººæ•°</div>
        </div>
        <div class="card-time" id="ts">æœ€çµ‚æ›´æ–°: --:--:--</div>
      </div>

      <div class="card-body">
        <div id="statusGrid" class="server-grid">
          <?php foreach($SERVERS as $srv):
              $sid=$srv['id'];
              $st=$initialServers[$sid] ?? ['running'=>false,'health'=>null];
              $online=$idleMin=null;
              if(is_array($initialPlayers['servers'] ?? null) && isset($initialPlayers['servers'][$sid])){
                  $online  = $initialPlayers['servers'][$sid]['online'] ?? null;
                  $idleMin = $initialPlayers['servers'][$sid]['idle_minutes'] ?? null;
              }

              $badgeClass='badge';
              $badgeText='ç¨¼åƒä¸­';
              if(!$st['running']){ $badgeClass.=' ng'; $badgeText='åœæ­¢ä¸­'; }
              elseif(!empty($st['health']) && $st['health']!=='healthy'){
                  $badgeClass.=' warn';
                  $badgeText.=' / '.h($st['health']);
              }
          ?>
          <div class="server-tile" data-id="<?=h($sid)?>">
            <div class="server-icon">
              <img src="<?=h($srv['img'])?>" alt="<?=h($srv['label'])?>">
            </div>
            <div class="server-main">
              <div class="server-name"><?=h($srv['label'])?></div>
              <?php if($srv['hostport']): ?>
              <div class="server-addr">
                <span><?=h($srv['hostport'])?></span>
                <button class="copy-btn" onclick="copyText('<?=h($srv['hostport'])?>')">ã‚³ãƒ”ãƒ¼</button>
              </div>
              <?php endif; ?>
              <div class="server-players" data-players>
                <?php if($online!==null): ?>
                  ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: <?=h($online)?>äºº
                  <?php if($online===0 && $idleMin>0): ?>
                    <?php if($autoStopEnabled): ?>
                    / ç„¡äºº<?=h($idleMin)?>åˆ†ï¼ˆ<?=h($autoStopMinutes)?>åˆ†ã§è‡ªå‹•åœæ­¢ï¼‰
                    <?php else: ?>
                    / ç„¡äºº<?=h($idleMin)?>åˆ†ï¼ˆè‡ªå‹•åœæ­¢ã¯ç„¡åŠ¹ï¼‰
                    <?php endif; ?>
                  <?php endif; ?>
                <?php else: ?>
                  ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: å–å¾—ä¸­â€¦
                <?php endif; ?>
              </div>
            </div>
            <div class="<?=h($badgeClass)?>" data-badge><?=h($badgeText)?></div>
          </div>
          <?php endforeach; ?>
        </div>

        <div class="rules-block" style="margin-top:16px;">
          ãƒ»Valheim / 7DTD ã®å‚åŠ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯åŸºæœ¬ã€Œ<strong>changeme1234</strong>ã€ã§ã™ã€‚<br>
          ãƒ»ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SNSã‚„ä¸ç‰¹å®šå¤šæ•°ã«æ‹¡æ•£ã—ãªã„ã§ãã ã•ã„ã€‚<br>
        </div>
      </div>
    </div>

    <!-- guide / rules -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title-main">å‚åŠ ã‚¬ã‚¤ãƒ‰ & ãƒ«ãƒ¼ãƒ«</div>
          <div class="card-eyebrow">æ¥ç¶šæ–¹æ³• / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ / æ³¨æ„äº‹é …</div>
        </div>
      </div>

      <div class="card-body">
        <?php foreach($SERVERS as $srv): ?>
          <div class="guide-block">
            <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;"><?=h($srv['label'])?></div>
            <div>
              ãƒ»æ¥ç¶šå…ˆ: <code><?=h($srv['hostport'])?></code><br>
              ãƒ»å‚åŠ æ–¹æ³•: <?=h($srv['howto'])?><br>
              <?php if($srv['password']): ?>
              ãƒ»å‚åŠ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: <strong style="color:var(--text);"><?=h($srv['password'])?></strong><br>
              <?php endif; ?>
              <?php if($srv['extra']): ?>
              <?=nl2br(h($srv['extra']))?><br>
              <?php endif; ?>
            </div>
          </div>
        <?php endforeach; ?>
        <?php if (empty($SERVERS)): ?>
          <div class="rules-block" style="margin-top:10px;">
            ç¾åœ¨å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>
        <?php endif; ?>

        <div class="rules-block" style="margin-top:20px;">
          <strong>ã‚µãƒ¼ãƒãƒ¼é‹å–¶ãƒãƒªã‚·ãƒ¼</strong><br>
          ãƒ»ãƒ¯ãƒ¼ãƒ«ãƒ‰ã¯äºˆå‘Šãªããƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯/ãƒ¯ã‚¤ãƒ—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
          ãƒ»ãƒãƒ¼ãƒˆ/è’ã‚‰ã—/éè² è·ã¯ç¦æ­¢ã§ã™ã€‚<br>
          ãƒ»ä»–äººã®ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å‹æ‰‹ã«å…±æœ‰ãƒ»ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚<br>
          ãƒ»å•é¡Œè¡Œå‹•ã¯ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆé™¤å¤–ãƒ»BANå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚<br>
          <?php if ($autoStopEnabled): ?>
          ãƒ»0äººçŠ¶æ…‹ãŒç´„<?=h($autoStopMinutes)?>åˆ†ç¶šãã¨è‡ªå‹•åœæ­¢ã—ã¾ã™ã€‚å†èµ·å‹•ã—ãŸã„æ™‚ã¯Discordã§ä¾é ¼ã—ã¦ãã ã•ã„ã€‚<br>
          <?php else: ?>
          ãƒ»è‡ªå‹•åœæ­¢ã¯ç¾åœ¨ç„¡åŠ¹ã§ã™ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã¯ç¶™ç¶šã—ã¦è¨ˆæ¸¬ã•ã‚Œã¾ã™ï¼‰ã€‚<br>
          <?php endif; ?>
        </div>

        <div class="rules-block" style="margin-top:16px;">
          â€»å¸¸æ™‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚„ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šæ€§ã¯ä¿è¨¼ã§ãã¾ã›ã‚“ã€‚<br>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <section>
    <!-- whitelist -->
    <?php if ($minecraftEnabled): ?>
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title-main">Minecraft ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²</div>
          <div class="card-eyebrow">Minecraft(Javaç‰ˆ) ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã§ç”³è«‹</div>
        </div>
      </div>
      <div class="card-body">
        <?php if($flashMsg): ?>
          <div class="toast <?= $flashType==='error'?'err':'' ?> show" id="flash"><?=h($flashMsg)?></div>
          <script>setTimeout(()=>{const f=document.getElementById('flash');if(f)f.classList.remove('show')},4200);</script>
        <?php endif; ?>

        <div class="form-desc">
          Javaç‰ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’é€ä¿¡ã™ã‚‹ã¨ã€ã™ãã‚µãƒ¼ãƒãƒ¼ã«å…¥ã‚Œã‚‹ã‚ˆã†ç™»éŒ²ã—ã¾ã™ã€‚<br>
          é€ä¿¡å†…å®¹ã¯é‹å–¶ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚è’ã‚‰ã—è¡Œç‚ºãŒã‚ã‚Œã°è§£é™¤ã•ã‚Œã¾ã™ã€‚
        </div>

        <form method="post" onsubmit="return lockSubmit(this)">
          <input type="hidden" name="type" value="whitelist">
          <div class="form-group">
            <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆJavaç‰ˆï¼‰</label>
            <input type="text" name="mc_name" required placeholder="ä¾‹: Notch">
          </div>
          <div><button type="submit" class="btn-primary">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹</button></div>
        </form>

        <div style="border-top:1px solid rgba(255,255,255,.05);margin:20px 0 16px;"></div>

        <div class="wl-stats-row">
          <div>ç¾åœ¨ã®ç™»éŒ²æ•°: <strong><?=count($whitelist)?></strong> å</div>
          <button class="btn-primary" style="font-size:12px;padding:8px 12px;" onclick="location.reload()">æœ€æ–°è¡¨ç¤º</button>
        </div>

        <?php if(SHOW_WL_DETAILS): ?>
        <div style="margin-top:16px;max-height:220px;overflow:auto;border:1px solid rgba(255,255,255,.05);border-radius:var(--r-md);padding:8px 10px;background:rgba(0,0,0,.3);box-shadow:0 20px 40px rgba(0,0,0,.9);font-size:12px;line-height:1.4;">
          <?php foreach($whitelist as $e): ?>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);">
              <div><?=h($e['name']??'-')?></div>
              <div style="font-family:ui-monospace,Menlo,Consolas,monospace;color:var(--muted);"><?=h($e['uuid']??'-')?></div>
            </div>
          <?php endforeach; ?>
          <?php if(empty($whitelist)): ?>
            <div class="rules-block" style="font-size:12px;">ã¾ã ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
          <?php endif; ?>
        </div>
        <?php endif; ?>
      </div>
    </div>
    <?php endif; ?>

    <!-- feedback -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title-main">ğŸ“® ã”æ„è¦‹ãƒ»ä¸å…·åˆå ±å‘Š</div>
          <div class="card-eyebrow">æ­¢ã¾ã£ã¦ã‚‹/ãƒ©ã‚°ã„/æ¬²ã—ã„æ©Ÿèƒ½ãªã©</div>
        </div>
      </div>
      <div class="card-body">
        <div class="form-desc">
          ã‚µãƒ¼ãƒãƒ¼ã®ä¸å…·åˆã‚„ã€Œèµ·å‹•ã—ã¦ã»ã—ã„ã€ç­‰ã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚<br>
          å†…å®¹ã¯é‹å–¶ã®Discordã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚
        </div>

        <form method="post" onsubmit="return lockSubmit(this)">
          <input type="hidden" name="type" value="feedback">
          <div class="form-group">
            <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
            <textarea name="feedback" ></textarea>
          </div>
          <div><button type="submit" class="btn-primary">é€ä¿¡</button></div>
        </form>
      </div>
    </div>
  </section>
</main>

<div class="page-bottom-space"></div>

<script>
const AUTO_STOP_ENABLED = <?= $autoStopEnabled ? 'true' : 'false' ?>;
const AUTO_STOP_MINUTES = <?= (int)$autoStopMinutes ?>;
function toast(msg,err){
  const d=document.createElement('div');
  d.className='toast'+(err?' err':'')+' show';
  d.textContent=msg;
  document.body.appendChild(d);
  setTimeout(()=>d.classList.remove('show'),3500);
  setTimeout(()=>d.remove(),4200);
}
function copyText(t){
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(t).then(()=>toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: '+t));
  }else{
    const ta=document.createElement('textarea');
    ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
    toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: '+t);
  }
}
function lockSubmit(f){
  const btn=f.querySelector('button[type=submit]');
  if(btn){btn.disabled=true;btn.textContent='é€ä¿¡ä¸­â€¦';}
  return true;
}

async function refreshStatus(){
  try{
    const r=await fetch('?action=status',{cache:'no-store'});
    const j=await r.json();

    const ts=document.getElementById('ts');
    if(ts) ts.textContent='æœ€çµ‚æ›´æ–°: '+j.ts;

    for(const sid in j.servers){
      const info=j.servers[sid];
      const tile=document.querySelector('.server-tile[data-id="'+sid+'"]');
      if(!tile) continue;

      const badge=tile.querySelector('[data-badge]');
      if(badge){
        let cls='badge',text='ç¨¼åƒä¸­';
        if(!info.running){cls+=' ng';text='åœæ­¢ä¸­';}
        else if(info.health && info.health!=='healthy'){cls+=' warn';text+=' / '+info.health;}
        badge.className=cls;
        badge.textContent=text;
      }

      const pbox=tile.querySelector('[data-players]');
      const ps=j.players_now && j.players_now.servers && j.players_now.servers[sid];
      if(pbox && ps){
        let line='ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: '+ps.online+'äºº';
        if(ps.online===0 && ps.idle_minutes>0){
          if(AUTO_STOP_ENABLED){
            line+=' / ç„¡äºº'+ps.idle_minutes+'åˆ†ï¼ˆ'+AUTO_STOP_MINUTES+'åˆ†ã§è‡ªå‹•åœæ­¢ï¼‰';
          }else{
            line+=' / ç„¡äºº'+ps.idle_minutes+'åˆ†ï¼ˆè‡ªå‹•åœæ­¢ã¯ç„¡åŠ¹ï¼‰';
          }
        }
        pbox.textContent=line;
      }
    }
  }catch(e){console.error(e);}
}

document.addEventListener('DOMContentLoaded',()=>{
  refreshStatus();
  setInterval(refreshStatus,30000);
});
</script>

</body></html>
